<div class="forum-header-bar">
  <form id="searchForm" action="/forums/search" method="get" class="controls-form">

    <!-- SEARCH WRAPPER -->
    <div class="search-wrapper">
      <div class="search-section">
        <input
          type="text"
          name="text"
          id="searchInput"
          placeholder="Search posts..."
          value="{{text}}"
        />
        <button type="submit" class="search-button">üîç</button>
      </div>
    </div>

    <!-- FILTER WRAPPER (Select Forums vs Polls) -->
    <div class="filter-wrapper">
      <div class="filter-section">
        <label for="postTypeSelect">Type:</label>
        <select name="postType" id="postTypeSelect">
          <option value="" {{#unless postType}}selected{{/unless}}>All</option>
          <option value="forums" {{#if (eq postType "forums")}}selected{{/if}}>Forums</option>
          <option value="polls" {{#if (eq postType "polls")}}selected{{/if}}>Polls</option>
        </select>
      </div>
    </div>

    <!-- SORT WRAPPER -->
    <div class="sort-wrapper">
      <div class="sort-section">
        <label for="sortSelect">Sort by:</label>
        <select name="sort" id="sortSelect">
          <option value="createdAt" {{#if (eq sort "createdAt")}}selected{{/if}}>Latest</option>
          <option value="upVotes" {{#if (eq sort "upVotes")}}selected{{/if}}>Most UpVoted</option>
          <option value="downVotes" {{#if (eq sort "downVotes")}}selected{{/if}}>Most DownVoted</option>
        </select>
        <select name="order" id="orderSelect">
          <option value="desc" {{#if (eq order "desc")}}selected{{/if}}>Desc</option>
          <option value="asc" {{#if (eq order "asc")}}selected{{/if}}>Asc</option>
        </select>
      </div>
    </div>

  </form>
</div>

<div class="section-heading-bar">
  <h2 id="sectionHeading">
    {{#if (eq postType "polls")}}Polls{{else}}Forum Posts{{/if}}
  </h2>
  <a href="/forums/create" class="create-post-button">Create Post</a>
</div>

<!-- Combined Forum & Poll List -->
<div class="combined-posts-list">
  {{#each forumPosts}}
    <div class="forum-post-card">
      <!-- Report option -->
      <div class="post-actions report-action">
        <button class="report-button" data-id="{{this._id}}" title="Report">
          <img src="/public/images/icons/exclamation-mark.png" alt="Report Icon" class="action-icon" />
        </button>
      </div>

      <h3 class="forum-title">{{this.title}}</h3>
      <p class="forum-posted-by">Posted by: {{this.userId.firstName}}_{{this.userId.lastName}}</p>

      <!-- Render forum tags -->
      {{#if this.tags.length}}
        <div class="forum-tags">
          {{#each this.tags}}
            <span class="tag">{{this.name}}</span>
          {{/each}}
        </div>
      {{/if}}

      <p class="forum-content">{{this.content}}</p>
      {{#if this.imageURLs.length}}
        <div class="forum-images">
          {{#each this.imageURLs}}
            <img src="{{this}}" alt="Forum Image" class="forum-image" />
          {{/each}}
        </div>
      {{/if}}
      <div class="forum-buttons">
        <button class="vote-button upvote-button" data-id="{{this._id}}">
          <img src="/public/images/icons/upVote.png" alt="Upvote" class="vote-icon" /><span>{{this.upVotes}}</span>
        </button>
        <button class="vote-button downvote-button" data-id="{{this._id}}">
          <img src="/public/images/icons/downVote.png" alt="Downvote" class="vote-icon" /><span>{{this.downVotes}}</span>
        </button>
        <button class="comment-button" data-id="{{this._id}}">üí¨ Comment</button>

        <button class="report-button" data-id="{{_id}}">
          ‚ùóReport
        </button>
      </div>
    </div>

    {{#with (lookup ../pollPosts @index) as |poll|}}
      {{#if poll}}
        <div class="poll-post-card">
          <!-- Report option -->
          <div class="post-actions report-action">
            <button class="report-button" data-id="{{poll._id}}" title="Report">
              <img src="/public/images/icons/exclamation-mark.png" alt="Report Icon" class="action-icon" />
            </button>
          </div>

          <h3 class="poll-question">{{poll.question}}</h3>
          <p class="poll-created-by">Created by: {{poll.createdBy.firstName}}_{{poll.createdBy.lastName}}</p>

          <!-- Render poll tags -->
          {{#if poll.tags.length}}
            <div class="poll-tags">
              {{#each poll.tags}}
                <span class="tag">{{this.name}}</span>
              {{/each}}
            </div>
          {{/if}}

          <!-- Poll images -->
          {{#if poll.imageURLs.length}}
            <div class="poll-images">
              {{#each poll.imageURLs}}
                <img src="{{this}}" alt="Poll Image" class="poll-image" />
              {{/each}}
            </div>
          {{/if}}

          <ul class="poll-options-list">
            {{#each poll.options}}
              <li>{{this.answer}} &ndash; {{this.voterId.length}} votes</li>
            {{/each}}
          </ul>

          <!-- Only comment button for polls -->
          <div class="poll-buttons">
            <button class="comment-button" data-id="{{poll._id}}">üí¨ Comment</button>
          </div>
        </div>
      {{/if}}
    {{/with}}
  {{/each}}

  {{#each pollPosts}}
    {{#unless (lookup ../forumPosts @index)}}
      <div class="poll-post-card">
        <!-- Report option -->
        <div class="post-actions report-action">
          <button class="report-button" data-id="{{this._id}}" title="Report">
            <img src="/public/images/icons/exclamation-mark.png" alt="Report Icon" class="action-icon" />
          </button>
        </div>

        <h3 class="poll-question">{{this.question}}</h3>

        <!-- Render poll tags -->
        {{#if this.tags.length}}
          <div class="poll-tags">
            {{#each this.tags}}
              <span class="tag">{{this.name}}</span>
            {{/each}}
          </div>
        {{/if}}

        <ul class="poll-options-list">
          {{#each this.options}}
            <li class="poll-option-item">
              <span class="poll-option-text">{{this.answer}}</span>
              <span class="poll-option-votes">{{this.voterId.length}}</span>
            </li>
          {{/each}}
        </ul>
        <p class="poll-created-by">Created by: {{this.createdBy.firstName}}_{{this.createdBy.lastName}}</p>

        <!-- Only comment button for polls -->
        <div class="poll-buttons">
          <button class="comment-button" data-id="{{this._id}}">üí¨ Comment</button>
        </div>
      </div>
    {{/unless}}
  {{/each}}
</div>

<!-- REPORT MODAL -->
<div id="reportModal" class="modal-overlay" style="display:none;">
  <div class="modal-card">
    <h2>Report Content</h2>
    <form id="reportForm" action="/report" method="post">
      <input type="hidden" name="contentId" id="reportContentId" />
      <input type="hidden" name="userId" value="{{loggedUserId}}" />

      <label for="reportReason">Reason:</label>
      <textarea
        name="reason"
        id="reportReason"
        rows="4"
        required
        placeholder="Describe why you're reporting this‚Ä¶"
      ></textarea>

      <div class="modal-buttons">
        <button type="button" id="reportCancel">Cancel</button>
        <button type="submit">Submit Report</button>
      </div>
    </form>
  </div>
</div>

<script>
  const loggedInUserId = "{{loggedUserId}}";
</script>

<script src="/public/js/forumLanding.js"></script>
